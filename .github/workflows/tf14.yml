name: terraform-14

on: [ push, pull_request ]

jobs:
  terraform_validate:
    runs-on: ubuntu-latest
    steps:
      - name: prepare
        # tfswitch command line tool lets you switch between different versions of terraform.
        # If you do not have a particular version of terraform installed, tfswitch will download the version you desire.
        run: |
          echo "$HOME/.bin" >> $GITHUB_PATH
          curl -L https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh > /tmp/tfswitch-install.sh
          chmod +x /tmp/tfswitch-install.sh
          /tmp/tfswitch-install.sh -b $HOME/.bin
      -
        name: checkout                      # action checks-out your repository under $GITHUB_WORKSPACE, so your workflow can access it.
        uses: actions/checkout@v2
      -
        name: setup terraform
        uses: hashicorp/setup-terraform@v1  # sets up Terraform CLI in your GitHub Actions workflow
        with:
          terraform_version: 0.14.11
      -
        name: terraform init                # initialize a working directory containing Terraform configuration files.
        run: find . -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (cd "$m" && echo "$m - init" && terraform init -input=false -backend=false) || exit 1; done
      -
        name: terraform validate            # validates the configuration files in a directory
        run: find . -name ".terraform" -prune -o -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (cd "$m" && echo "$m - validate" && terraform validate && echo "âˆš $m") || exit 1 ; done
      -
        name: terraform fmt check           # perform format checks
        run: terraform fmt -list=true -write=false -check -recursive
      - 
        name: terraform plan check
        run: terraform plan -var="ibmcloud_api_key=${{ secrets.IBMCLOUD_API_KEY }}" -var="client_preshared_key=${{ secrets.CLIENT_PRESHARED_KEY }}" -var="client_public_key=${{ secrets.CLIENT_PUBLIC_KEY }}" -var="region=us-south" -var="allow_ssh_from=98.40.239.8" -var="existing_resource_group=CDE" -var="name=rtv1" -var="existing_ssh_key=hyperion-us-south" -out default.tfplan

